<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân khúc Khách hàng - DSS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .segment-card {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .segment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .segment-champions { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; }
        .segment-loyal { background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); color: #fff; }
        .segment-at-risk { background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%); color: #fff; }
        .segment-hibernating { background: linear-gradient(135deg, #95A5A6 0%, #7F8C8D 100%); color: #fff; }
        .segment-regulars { background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); color: #fff; }
        
        .metric-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2C3E50;
        }
        .metric-label {
            color: #7F8C8D;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .action-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            margin: 3px;
            font-size: 0.85rem;
        }
        
        .customer-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .settings-panel {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/sidebar :: sidebar"></div>
    
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-people-fill"></i> Phân khúc Khách hàng (RFM & K-Means)</h1>
            <button class="btn btn-primary" onclick="refreshAnalysis()">
                <i class="bi bi-arrow-clockwise"></i> Làm mới phân tích
            </button>
        </div>
        
        <!-- Settings Panel -->
        <div class="settings-panel">
            <h5><i class="bi bi-gear-fill"></i> Cài đặt Phân tích</h5>
            <div class="row mt-3">
                <div class="col-md-3">
                    <label class="form-label">Số lượng phân khúc (K)</label>
                    <input type="number" class="form-control" id="numClusters" value="5" min="2" max="10">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Khoảng thời gian</label>
                    <select class="form-select" id="dateRange">
                        <option value="30">30 ngày gần nhất</option>
                        <option value="90">90 ngày gần nhất</option>
                        <option value="180" selected>6 tháng gần nhất</option>
                        <option value="365">1 năm gần nhất</option>
                        <option value="all">Toàn bộ dữ liệu</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Lọc theo quốc gia</label>
                    <select class="form-select" id="countryFilter">
                        <option value="all">Tất cả quốc gia</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-success w-100" onclick="applyFilters()">
                        <i class="bi bi-funnel-fill"></i> Áp dụng
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Summary Metrics -->
        <div class="row mb-4" id="summaryMetrics">
            <div class="col-md-3">
                <div class="metric-box">
                    <div class="metric-value" id="totalCustomers">0</div>
                    <div class="metric-label">Tổng Khách hàng</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-box">
                    <div class="metric-value" id="totalRevenue">$0</div>
                    <div class="metric-label">Tổng Doanh thu</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-box">
                    <div class="metric-value" id="avgRecency">0</div>
                    <div class="metric-label">Recency TB (ngày)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-box">
                    <div class="metric-value" id="avgFrequency">0</div>
                    <div class="metric-label">Frequency TB (đơn)</div>
                </div>
            </div>
        </div>
        
        <!-- Segment Overview Cards -->
        <h3 class="mt-4 mb-3"><i class="bi bi-pie-chart-fill"></i> Tổng quan Phân khúc</h3>
        <div class="row" id="segmentCards">
            <!-- Dynamically loaded -->
        </div>
        
        <!-- Charts -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="segmentDistributionChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="rfmScatterChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Segment Details Tabs -->
        <h3 class="mt-4 mb-3"><i class="bi bi-list-check"></i> Chi tiết Phân khúc</h3>
        <ul class="nav nav-tabs" id="segmentTabs" role="tablist">
            <!-- Dynamically loaded -->
        </ul>
        <div class="tab-content mt-3" id="segmentTabContent">
            <!-- Dynamically loaded -->
        </div>
        
        <!-- Export Options -->
        <div class="mt-4">
            <button class="btn btn-outline-primary" onclick="exportSegmentData()">
                <i class="bi bi-download"></i> Xuất dữ liệu (.CSV)
            </button>
            <button class="btn btn-outline-info" onclick="exportSegmentReport()">
                <i class="bi bi-file-earmark-pdf"></i> Xuất báo cáo (.PDF)
            </button>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        let segmentData = null;
        let charts = {};
        
        async function loadSegmentAnalysis() {
            try {
                showLoading();
                const k = document.getElementById('numClusters').value;
                const dateRange = document.getElementById('dateRange').value;
                const country = document.getElementById('countryFilter').value;
                
                const params = new URLSearchParams({ k, dateRange, country });
                const data = await fetchData(`/api/marketing/segments?${params}`);
                
                if (data) {
                    segmentData = data;
                    updateSummaryMetrics(data.summary);
                    renderSegmentCards(data.segments);
                    renderCharts(data);
                    renderSegmentTabs(data.segments);
                    populateCountryFilter(data.countries);
                }
            } catch (error) {
                console.error('Error loading segments:', error);
                alert('Lỗi khi tải dữ liệu phân khúc. Vui lòng thử lại.');
            } finally {
                hideLoading();
            }
        }
        
        function updateSummaryMetrics(summary) {
            document.getElementById('totalCustomers').textContent = summary.totalCustomers.toLocaleString();
            document.getElementById('totalRevenue').textContent = formatCurrency(summary.totalRevenue);
            document.getElementById('avgRecency').textContent = Math.round(summary.avgRecency);
            document.getElementById('avgFrequency').textContent = summary.avgFrequency.toFixed(1);
        }
        
        function renderSegmentCards(segments) {
            const container = document.getElementById('segmentCards');
            const segmentClasses = {
                'Champions': 'segment-champions',
                'Loyal': 'segment-loyal',
                'At-Risk': 'segment-at-risk',
                'Hibernating': 'segment-hibernating',
                'Regulars': 'segment-regulars'
            };
            
            container.innerHTML = segments.map(seg => `
                <div class="col-md-6 col-lg-4">
                    <div class="segment-card ${segmentClasses[seg.name] || ''}">
                        <h4><i class="bi bi-award-fill"></i> ${seg.name}</h4>
                        <div class="mt-3">
                            <p><strong>${seg.customerCount}</strong> khách hàng (${seg.percentage.toFixed(1)}%)</p>
                            <p><strong>${formatCurrency(seg.totalRevenue)}</strong> doanh thu</p>
                            <p class="mb-1"><small>R: ${seg.avgRecency.toFixed(0)} | F: ${seg.avgFrequency.toFixed(1)} | M: ${formatCurrency(seg.avgMonetary)}</small></p>
                        </div>
                        <hr style="border-color: rgba(255,255,255,0.3);">
                        <div>
                            <strong><i class="bi bi-lightbulb-fill"></i> Hành động đề xuất:</strong>
                            ${seg.actions.map(action => `<span class="action-badge">${action}</span>`).join('')}
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-light w-100" onclick="viewSegmentDetails('${seg.name}')">
                                Xem chi tiết <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderCharts(data) {
            // Destroy old charts
            Object.values(charts).forEach(chart => chart?.destroy());
            
            // Segment Distribution Pie Chart
            const distCtx = document.getElementById('segmentDistributionChart').getContext('2d');
            charts.distribution = new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: data.segments.map(s => s.name),
                    datasets: [{
                        data: data.segments.map(s => s.customerCount),
                        backgroundColor: ['#FFD700', '#4A90E2', '#E74C3C', '#95A5A6', '#2ECC71'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Phân bố Phân khúc Khách hàng',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // RFM Scatter Chart
            const scatterCtx = document.getElementById('rfmScatterChart').getContext('2d');
            const scatterData = data.segments.map(seg => ({
                x: seg.avgRecency,
                y: seg.avgFrequency,
                r: Math.sqrt(seg.avgMonetary) / 10,
                label: seg.name
            }));
            
            charts.scatter = new Chart(scatterCtx, {
                type: 'bubble',
                data: {
                    datasets: data.segments.map((seg, idx) => ({
                        label: seg.name,
                        data: [{
                            x: seg.avgRecency,
                            y: seg.avgFrequency,
                            r: Math.sqrt(seg.avgMonetary) / 10
                        }],
                        backgroundColor: ['#FFD700', '#4A90E2', '#E74C3C', '#95A5A6', '#2ECC71'][idx] + '80'
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'RFM Scatter Plot (Recency vs Frequency)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'right'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Recency (ngày)' },
                            reverse: true
                        },
                        y: {
                            title: { display: true, text: 'Frequency (đơn hàng)' }
                        }
                    }
                }
            });
        }
        
        function renderSegmentTabs(segments) {
            const tabsContainer = document.getElementById('segmentTabs');
            const contentContainer = document.getElementById('segmentTabContent');
            
            tabsContainer.innerHTML = segments.map((seg, idx) => `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${idx === 0 ? 'active' : ''}" 
                            id="tab-${seg.name}" 
                            data-bs-toggle="tab" 
                            data-bs-target="#content-${seg.name}" 
                            type="button">
                        ${seg.name} (${seg.customerCount})
                    </button>
                </li>
            `).join('');
            
            contentContainer.innerHTML = segments.map((seg, idx) => `
                <div class="tab-pane fade ${idx === 0 ? 'show active' : ''}" 
                     id="content-${seg.name}" 
                     role="tabpanel">
                    <div class="customer-table">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Recency (ngày)</th>
                                    <th>Frequency (đơn)</th>
                                    <th>Monetary (doanh thu)</th>
                                    <th>Quốc gia</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="customers-${seg.name}">
                                <tr><td colspan="6" class="text-center">Đang tải...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
            
            // Load first segment customers
            if (segments.length > 0) {
                loadSegmentCustomers(segments[0].name);
            }
        }
        
        async function loadSegmentCustomers(segmentName) {
            const tbody = document.getElementById(`customers-${segmentName}`);
            if (!tbody || tbody.dataset.loaded === 'true') return;
            
            try {
                const customers = await fetchData(`/api/marketing/segments/${segmentName}/customers`);
                tbody.innerHTML = customers.map(cust => `
                    <tr>
                        <td><strong>${cust.customerId}</strong></td>
                        <td>${cust.recency}</td>
                        <td>${cust.frequency}</td>
                        <td>${formatCurrency(cust.monetary)}</td>
                        <td>${cust.country || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewCustomerDetail(${cust.customerId})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                tbody.dataset.loaded = 'true';
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
            }
        }
        
        function viewSegmentDetails(segmentName) {
            const tab = document.getElementById(`tab-${segmentName}`);
            if (tab) {
                tab.click();
                loadSegmentCustomers(segmentName);
            }
        }
        
        function viewCustomerDetail(customerId) {
            window.location.href = `/customer/${customerId}`;
        }
        
        function populateCountryFilter(countries) {
            const select = document.getElementById('countryFilter');
            const currentValue = select.value;
            select.innerHTML = '<option value="all">Tất cả quốc gia</option>' + 
                countries.map(c => `<option value="${c}">${c}</option>`).join('');
            select.value = currentValue;
        }
        
        function applyFilters() {
            loadSegmentAnalysis();
        }
        
        function refreshAnalysis() {
            loadSegmentAnalysis();
        }
        
        function exportSegmentData() {
            if (!segmentData) return;
            window.location.href = '/api/marketing/segments/export?format=csv';
        }
        
        function exportSegmentReport() {
            if (!segmentData) return;
            window.location.href = '/api/marketing/segments/export?format=pdf';
        }
        
        function showLoading() {
            // Add loading spinner
            document.body.style.cursor = 'wait';
        }
        
        function hideLoading() {
            document.body.style.cursor = 'default';
        }
        
        // Event listeners for tab changes
        document.addEventListener('shown.bs.tab', (event) => {
            const segmentName = event.target.getAttribute('data-bs-target').replace('#content-', '');
            loadSegmentCustomers(segmentName);
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSegmentAnalysis();
        });
    </script>
</body>
</html>

